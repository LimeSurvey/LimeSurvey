var LS=LS||{onDocumentReady:{}},PrepEmailTemplates=function(){function editAttachmentRelevance(e){e.preventDefault();var target=$(this).parents("tr").find("input.relevance"),span=$(this).parents("tr").find("span.relevance");$("#attachment-relevance-editor textarea").val($(target).val()),$("#attachment-relevance-editor").modal({backdrop:"static",keyboard:!1});const attachmentRelevanceModal=bootstrap.Modal.getOrCreateInstance(document.getElementById("attachment-relevance-editor"),{backdrop:"static",keyboard:!1});attachmentRelevanceModal.show(),$("#attachment-relevance-editor .btn-primary").one("click",function(event){var newRelevanceEquation=$("#attachment-relevance-editor textarea").val();$(target).val(newRelevanceEquation),50<newRelevanceEquation.length?$(span).html(newRelevanceEquation.replace(/(\r\n|\n|\r)/gm,"").substr(0,47)+"..."):$(span).html(newRelevanceEquation),attachmentRelevanceModal.hide()})}function addAttachment(target,url,relevance,size,error){void 0===relevance&&(relevance="1"),void 0===size&&(size="-");var index,newrow,filename=decodeURIComponent(url.replace(/^.*[\\\/]/,"")),baserow=$("#rowTemplate").find("tbody").html();$(target).is("table")?(newrow=$(baserow).clone(),baserow=$(target).attr("data-template"),index=$(target).find("tr").length-1,50<relevance.length?$(newrow).find("span.relevance").html(relevance.replace(/(\r\n|\n|\r)/gm,"").substr(0,47)+"..."):$(newrow).find("span.relevance").html(relevance),$(newrow).find("input.relevance").val(relevance).attr("name","attachments"+baserow+"["+index+"][relevance]"),$(newrow).find("input.filename").attr("name","attachments"+baserow+"["+index+"][url]"),error&&$(newrow).find("input.filename").parent().append($("<span class='fa fa-exclamation-triangle text-danger' title='"+error+"'></span>")),$(newrow).appendTo($(target).find("tbody")),bootstrap.Modal.getOrCreateInstance(document.getElementById("kc-modal-open")).hide()):newrow=target,$(".edit-relevance-equation").off("click").on("click",editAttachmentRelevance),$(".btnattachmentremove").off("click").on("click",removeAttachment),$("span.filename").off("click").on("click",function(e){e.preventDefault();var e=$(this).parents("tr"),ckTarget=$(this).parents("table").data("ck-target");uri=LS.data.baseUrl+"/vendor/kcfinder/browse.php?opener=custom&type=files&CKEditor="+ckTarget+"&langCode="+sKCFinderLanguage,openKCFinderSingleFile(e,uri)}),$(newrow).find("span.filesize").text(function(bytes){if(bytes>=1e6)return(bytes/1e6).toFixed(2)+"MB";else if(bytes<1e6)return(bytes/1e3).toFixed(0)+"KB";return bytes}(size)),$(newrow).find("span.filename").text(filename),$(newrow).find("input.filename").val(url)}function removeAttachment(e){e.preventDefault(),$(this).parents("tr").remove()}function openKCFinderSingleFile(target,uri){var modalElement=document.getElementById("kc-modal-open"),modal=new bootstrap.Modal(modalElement);modalElement.addEventListener("shown.bs.modal",function(){currentTarget=target,window.KCFinder={},window.KCFinder.target=target,window.KCFinder.callBack=kcFinderCallback,$("#kc-modal-open").find("iframe").attr("src",uri)},{once:!0}),modalElement.addEventListener("hidden.bs.modal",function(){$(this).find("iframe").attr("src","about:blank")},{once:!0}),modal.show()}var currentTarget=null,kcFinderCallback=function(url){$(currentTarget).closest(".selector__table-container").hasClass("d-none")&&$(currentTarget).closest(".selector__table-container").removeClass("d-none"),addAttachment(currentTarget,url),window.KCFinder=null,bootstrap.Modal.getOrCreateInstance(document.getElementById("kc-modal-open")).hide()};return{init:function(modal_id){$(".fillin").off("click").on("click",function(e){e.preventDefault;var e=$(this).attr("data-value"),target=$("#"+$(this).attr("data-target"));$(target).val(e);try{updateCKeditor($(this).attr("data-target"),e)}catch(err){}}),$("button.add-attachment").off("click.emailtemplates").on("click.emailtemplates",function(e){e.preventDefault();var e=$($(this).data("target")),ckTarget=$(this).data("ck-target"),ckTarget=LS.data.baseUrl+"/vendor/kcfinder/browse.php?opener=custom&type=files&CKEditor="+ckTarget+"&langCode="+sKCFinderLanguage;openKCFinderSingleFile(e,ckTarget)})},bindActions:function(elements,translate,resetUrl){$(elements.validate).remoteModal({},{closeIcon:'<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="'+translate.close+'"></button>',closeButton:'<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">'+translate.close+"</button>",saveButton:'<button type="button" class="btn btn-primary">'+translate.save+"</button>"}),$(elements.reset).on("click",function(){var $self=$(this);$.ajax({url:resetUrl,dataType:"html",success:function(result){void 0!==CKEDITOR&&CKEDITOR.instances[$self.data("target")]?CKEDITOR.instances[$self.data("target")].setData(result):$("#"+$self.data("target")).val(result)},error:console.ls.error,beforeSend:function(){void 0!==CKEDITOR&&CKEDITOR.instances[$self.data("target")]?CKEDITOR.instances[$self.data("target")].setData(""):$("#"+$self.data("target")).val("")}})})},currentTarget:currentTarget,addAttachment:addAttachment}};
