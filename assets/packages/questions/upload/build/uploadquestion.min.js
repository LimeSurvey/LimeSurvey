"use strict";function openUploadModalDialog(){$(".upload").click(function(e){e.preventDefault();$(this);var t=getQueryVariable("show_title",this.href),a=getQueryVariable("show_comment",this.href),n=getQueryVariable("pos",this.href),i=getQueryVariable("fieldname",this.href);({})[uploadLang.returnTxt]=function(){$(this).dialog("close")},$("#file-upload-modal-"+i).modal("show"),$(document).on("shown.bs.modal","#file-upload-modal-"+i,function(){var e=$("#uploader"+i);e.load(e.data("src")),updateMaxHeightModalbody($(this))}),$("#file-upload-modal-"+i).on("hide.bs.modal",function(){window.uploadModalObjects[i].saveAndExit(i,t,a,n)})})}function updateUploadFrame(e,t){$("#"+e).innerHeight(t)}function updateMaxHeightModalbody(e){var t=$(e).find(".modal-header").outerHeight(),a=$(e).find(".modal-footer").outerHeight();console.ls.log([$(window).height(),t,a,t+a]);var n=Math.max(150,$(window).height()-(t+a+16));$(e).find(".modal-body").css("max-height",n)}function getQueryVariable(e,t){for(var a=t.split("/"),n=0;n<a.length;n++)if(a[n]==e)return a[n+1];for(a=t.replace(/\&amp;/g,"&").split("&"),n=0;n<a.length;n++){var i=a[n].split("=");if(i[0]==e)return i[1]}return null}function isValueInArray(e,t){for(inArray=!1,i=0;i<e.length;i++)t.toLowerCase()==e[i].toLowerCase()&&(inArray=!0);return inArray}!function(){function addEvent(e,t,a){if(e.addEventListener)e.addEventListener(t,a,!1);else{if(!e.attachEvent)throw new Error("not supported or DOM not loaded");e.attachEvent("on"+t,function(){a.call(e)})}}function addResizeEvent(e){var t;addEvent(window,"resize",function(){t&&clearTimeout(t),t=setTimeout(e,100)})}if(document.documentElement.getBoundingClientRect)var getOffset=function(e){var t=e.getBoundingClientRect(),a=e.ownerDocument,n=a.body,i=a.documentElement,o=i.clientTop||n.clientTop||0,l=i.clientLeft||n.clientLeft||0,s=1;if(n.getBoundingClientRect){var r=n.getBoundingClientRect();s=(r.right-r.left)/n.clientWidth}return s>1&&(o=0,l=0),{top:t.top/s+(window.pageYOffset||i&&i.scrollTop/s||n.scrollTop/s)-o,left:t.left/s+(window.pageXOffset||i&&i.scrollLeft/s||n.scrollLeft/s)-l}};else var getOffset=function(e){var t=0,a=0;do{t+=e.offsetTop||0,a+=e.offsetLeft||0,e=e.offsetParent}while(e);return{left:a,top:t}};function getBox(e){var t,a,n=getOffset(e);return t=n.left,a=n.top,{left:t,right:t+e.offsetWidth,top:a,bottom:a+e.offsetHeight}}function addStyles(e,t){for(var a in t)t.hasOwnProperty(a)&&(e.style[a]=t[a])}function copyLayout(e,t){var a=getBox(e);addStyles(t,{position:"absolute",left:a.left+"px",top:a.top+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px"})}var toElement=(J=document.createElement("div"),function(e){J.innerHTML=e;var t=J.firstChild;return J.removeChild(t)}),J,getUID=(M=0,function(){return"ValumsAjaxUpload"+M++}),M;function fileFromPath(e){return e.replace(/.*(\/|\\)/,"")}function getExt(e){return-1!==(e=e.toLowerCase()).indexOf(".")?e.replace(/.*[.]/,""):""}function hasClass(e,t){return new RegExp("\\b"+t+"\\b").test(e.className)}function addClass(e,t){hasClass(e,t)||(e.className+=" "+t)}function removeClass(e,t){var a=new RegExp("\\b"+t+"\\b");e.className=e.className.replace(a,"")}function removeNode(e){e.parentNode.removeChild(e)}window.AjaxUpload=function(e,t){this._settings={action:"upload.php",name:"userfile",multiple:!1,data:{},autoSubmit:!0,responseType:!1,hoverClass:"hover",focusClass:"focus",disabledClass:"disabled",onChange:function(e,t){},onSubmit:function(e,t){},onComplete:function(e,t){}};for(var a in t)t.hasOwnProperty(a)&&(this._settings[a]=t[a]);if(e.jquery?e=e[0]:"string"==typeof e&&(/^#.*/.test(e)&&(e=e.slice(1)),e=document.getElementById(e)),!e||1!==e.nodeType)throw new Error("Please make sure that you're passing a valid element");"A"==e.nodeName.toUpperCase()&&addEvent(e,"click",function(e){e&&e.preventDefault?e.preventDefault():window.event&&(window.event.returnValue=!1)}),this._button=e,this._input=null,this._disabled=!1,this.enable(),this._rerouteClicks()},AjaxUpload.prototype={setData:function(e){this._settings.data=e},disable:function(){addClass(this._button,this._settings.disabledClass),this._disabled=!0;var e=this._button.nodeName.toUpperCase();"INPUT"!=e&&"BUTTON"!=e||this._button.setAttribute("disabled","disabled"),this._input&&this._input.parentNode&&(this._input.parentNode.style.visibility="hidden")},enable:function(){removeClass(this._button,this._settings.disabledClass),this._button.removeAttribute("disabled"),this._disabled=!1},_createInput:function(){var e=this,t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("name",this._settings.name),this._settings.multiple&&t.setAttribute("multiple","multiple"),addStyles(t,{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",fontFamily:"sans-serif",cursor:"pointer"});var a=document.createElement("div");if(addStyles(a,{display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483583}),"0"!==a.style.opacity){if(void 0===a.filters)throw new Error("Opacity not supported by the browser");a.style.filter="alpha(opacity=0)"}addEvent(t,"change",function(){if(t&&""!==t.value){var a=fileFromPath(t.value);!1!==e._settings.onChange.call(e,a,getExt(a))?e._settings.autoSubmit&&e.submit():e._clearInput()}}),addEvent(t,"mouseover",function(){addClass(e._button,e._settings.hoverClass)}),addEvent(t,"mouseout",function(){removeClass(e._button,e._settings.hoverClass),removeClass(e._button,e._settings.focusClass),t.parentNode&&(t.parentNode.style.visibility="hidden")}),addEvent(t,"focus",function(){addClass(e._button,e._settings.focusClass)}),addEvent(t,"blur",function(){removeClass(e._button,e._settings.focusClass)}),a.appendChild(t),document.body.appendChild(a),this._input=t},_clearInput:function(){this._input&&(removeNode(this._input.parentNode),this._input=null,this._createInput(),removeClass(this._button,this._settings.hoverClass),removeClass(this._button,this._settings.focusClass))},_rerouteClicks:function(){var e=this;addEvent(e._button,"mouseover",function(){if(!e._disabled){e._input||e._createInput();var t=e._input.parentNode;copyLayout(e._button,t),t.style.visibility="visible"}})},_createIframe:function(){var e=getUID(),t=toElement('<iframe src="javascript:false;" name="'+e+'" />');return t.setAttribute("id",e),t.style.display="none",document.body.appendChild(t),t},_createForm:function(e){var t=this._settings,a=toElement('<form method="post" enctype="multipart/form-data"></form>');a.setAttribute("action",t.action),a.setAttribute("target",e.name),a.style.display="none",document.body.appendChild(a);for(var n in t.data)if(t.data.hasOwnProperty(n)){var i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("name",n),i.setAttribute("value",t.data[n]),a.appendChild(i)}return a},_getResponse:function _getResponse(iframe,file){var toDeleteFlag=!1,self=this,settings=this._settings;addEvent(iframe,"load",function(){if("javascript:'%3Chtml%3E%3C/html%3E';"!=iframe.src&&"javascript:'<html></html>';"!=iframe.src){var doc=iframe.contentDocument?iframe.contentDocument:window.frames[iframe.id].document,response;if(!doc.readyState||"complete"==doc.readyState)if(!doc.body||"false"!=doc.body.innerHTML)doc.XMLDocument?response=doc.XMLDocument:doc.body?(response=doc.body.innerHTML,settings.responseType&&"json"==settings.responseType.toLowerCase()&&(doc.body.firstChild&&"PRE"==doc.body.firstChild.nodeName.toUpperCase()&&(doc.normalize(),response=doc.body.firstChild.firstChild.nodeValue),response=response?eval("("+response+")"):{})):response=doc,settings.onComplete.call(self,file,response),toDeleteFlag=!0,iframe.src="javascript:'<html></html>';"}else toDeleteFlag&&setTimeout(function(){removeNode(iframe)},0)})},submit:function(){var e=this._settings;if(this._input&&""!==this._input.value){var t=fileFromPath(this._input.value);if(!1!==e.onSubmit.call(this,t,getExt(t))){var a=this._createIframe(),n=this._createForm(a);removeNode(this._input.parentNode),removeClass(this._button,this._settings.hoverClass),removeClass(this._button,this._settings.focusClass),n.appendChild(this._input),n.submit(),removeNode(n),n=null,removeNode(this._input),this._input=null,this._getResponse(a,t),this._createInput()}else this._clearInput()}}}}(),window.uploadModalObjects=window.uploadModalObjects||{},$(function(){openUploadModalDialog()});var displayUploadedFiles=function(e,t,a,n){var i=$("#"+t).val(),o="";if("[]"!=i&&""!=i){if(""!==i){var l=[];try{l=JSON.parse(i)}catch(e){}var s=$('<table width="100%" class="question uploadedfiles"></table>');$("<thead></thead>").appendTo(s).append($("<tr></tr>").append('<th width="20%">&nbsp;</th>')),0!=a&&(o+="<th>"+uploadLang.headTitle+"</th>"),0!=n&&(o+="<th>"+uploadLang.headComment+"</th>"),o+="<th>"+uploadLang.headFileName+'</th><th class="edit"></th></tr></thead><tbody>';var r=new Array("gif","jpeg","jpg","png","swf","psd","bmp","tiff","jp2","iff","bmp","xbm","ico");l.forEach(function(e,i){isValueInArray(r,e.ext)?o+='<tr><td class="upload image"><img src="'+uploadurl+"/filegetcontents/"+decodeURIComponent(e.filename)+'" class="uploaded" /></td>':o+='<tr><td class="upload placeholder"><div class="upload-placeholder" /></td>',0!=a&&(o+='<td class="upload title">'+e.title+"</td>"),0!=n&&(o+='<td class="upload comment">'+e.comment+"</td>"),o+='<td class="upload edit">'+decodeURIComponent(e.name)+'</td><td><a class="btn btn-primary" onclick="javascript:upload_'+t+"();$('#upload_"+t+'\').click();"><span class="fa fa-pencil"></span>&nbsp;'+uploadLang.editFile+"</a></td></tr>"}),o+="</tbody></table>",$("#"+t+"_uploadedfiles").html(o)}}else $("#"+t+"_uploadedfiles").html(o)};function showBasic(){$("#basic").show()}function hideBasic(){$("#basic").hide()}var uploadHandler=function uploadHandler(qid,options){var init=function(){$(document).on("ready pjax:scriptcomplete",function(){doFileUpload()})},fixParentHeigth=function(){},renderPreviewItem=function(e,t,a){var n=a+1,i=$('<li id="'+e+"_li_"+n+'" class="previewblock file-element"></li>'),o=$('<div class="file-preview"></div>');if(RegExp(image_extensions).test(t.ext.toLowerCase())?o.append('<img src="'+options.uploadurl+"/filegetcontents/"+t.filename+'" class="uploaded" />'):o.append('<div class="upload-placeholder"></div>'),o.append('<span class="file-name">'+escapeHtml(decodeURIComponent(t.name))+"</span>"),1==$("#"+e+"_show_title").val()||1==$("#"+e+"_show_comment").val()){var l=$(""),s=$("");if(1==$("#"+e+"_show_title").val()){l=$('<div class="form-group"></div>');$('<label class="control-label col-xs-4"></label>').attr("for",e+"_title_"+n).text(options.uploadLang.titleFld).appendTo(l),$('<input class="form-control" type="text"/>').attr("id",e+"_title_"+n).val(t.title).wrap('<div class="input-container"></div>').appendTo(l)}if(1==$("#"+e+"_show_comment").val()){s=$('<div class="form-group"></div>');$('<label class="control-label col-xs-4"></label>').attr("for",e+"_comment_"+n).text(options.uploadLang.commentFld).appendTo(s),$('<input class="form-control" type="text"/>').attr("id",e+"_comment_"+n).val(t.comment).wrap('<div class="input-container"></div>').appendTo(s)}}var r=$('<div class="form-group"></div>').append($('<a class="btn btn-danger"></a>').html('<span class="fa fa-trash"></span>&nbsp;'+options.uploadLang.deleteFile).on("click",function(){deletefile(e,n)}).wrap('<div class="input-container text-center"></div>'));$("<fieldset></fieldset>").append(l).append(s).append(r).wrap('<div class="file-info"></div>').appendTo(o),i.append(o),$('<input type="hidden" />').attr("id",e+"_size_"+n).attr("value",t.size).appendTo(i),$('<input type="hidden" />').attr("id",e+"_name_"+n).attr("value",t.name).appendTo(i),$('<input type="hidden" />').attr("id",e+"_file_index_"+n).attr("value",n).appendTo(i),$('<input type="hidden" />').attr("id",e+"_filename_"+n).attr("value",t.filename).appendTo(i),$('<input type="hidden" />').attr("id",e+"_ext_"+n).attr("value",t.ext).appendTo(i),$("#field"+e+"_listfiles").append(i)},doFileUpload=function doFileUpload(){var fieldname=options.fieldname,filecount=$("#"+fieldname+"_filecount").val();$("#"+fieldname+"_filecount").val(filecount);var image_extensions=["gif","jpeg","jpg","png","swf","psd","bmp","tiff","jp2","iff","bmp","xbm","ico"];if(filecount>0){var jsontext=$("#"+fieldname).val(),json="";try{json=JSON.parse(jsontext)}catch(e){}0==$("#field"+fieldname+"_listfiles").length&&$('<ul id="field'+fieldname+'_listfiles" class="files-list" />').insertAfter("#uploadstatus_"+qid),$("#"+fieldname+"_licount").val(filecount),json.forEach(function(e,t){renderPreviewItem(fieldname,e,t)})}var button=$("#button1");new AjaxUpload(button,{action:options.uploadurl+"/sid/"+surveyid+"/preview/"+options.questgrppreview+"/fieldname/"+fieldname+"/",name:"uploadfile",data:{valid_extensions:$("#"+fieldname+"_allowed_filetypes").val(),max_filesize:$("#"+fieldname+"_maxfilesize").val(),preview:$("#preview").val(),surveyid:surveyid,fieldname:fieldname,YII_CSRF_TOKEN:options.csrfToken},onSubmit:function(e,t){var a=parseInt($("#"+fieldname+"_maxfiles").val()),n=parseInt($("#"+fieldname+"_filecount").val()),i=$("#"+fieldname+"_allowed_filetypes").val().split(",");return n>=a?($("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+uploadLang.errorNoMoreFiles+"</p>"),fixParentHeigth(),!1):0==i.reduce(function(e,a){return e||t.toLowerCase()===a},!1)?($("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+uploadLang.errorOnlyAllowed.replace("%s",$("#"+fieldname+"_allowed_filetypes").val())+"</p>"),fixParentHeigth(),!1):(button.text(options.uploadLang.uploading),this.disable(),void button.append('<i id="loading-icon-fielupload" class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>'))},onComplete:function onComplete(file,response){button.text(uploadLang.selectfile),$("#loading-icon-fielupload").remove(),this.enable();var metadata=eval("("+response+")"),count=parseInt($("#"+fieldname+"_licount").val());if(count++,$("#"+fieldname+"_licount").val(count),metadata.success){$("#notice").html('<p class="alert alert-success"><span class="fa fa-success"></span>&nbsp;'+metadata.msg+"</p>"),0==$("#field"+fieldname+"_listfiles").length&&$("<ul id='field"+fieldname+"_listfiles' class='files-list' />").insertAfter("#uploadstatus_"+options.qid),renderPreviewItem(fieldname,metadata,count);var filecount=parseInt($("#"+fieldname+"_filecount").val()),minfiles=parseInt($("#"+fieldname+"_minfiles").val());filecount++;var maxfiles=parseInt($("#"+fieldname+"_maxfiles").val());$("#"+fieldname+"_filecount").val(filecount),filecount<minfiles?$("#uploadstatus").html(options.uploadLang.errorNeedMore.replace("%s",minfiles-filecount)):filecount<maxfiles?$("#uploadstatus").html(options.uploadLang.errorMoreAllowed.replace("%s",maxfiles-filecount)):$("#uploadstatus").html(options.uploadLang.errorMaxReached),fixParentHeigth(),filecount>=maxfiles&&$("#notice").html('<p class="alert alert-success"><span class="fa fa-check"></span>&nbsp;'+options.uploadLang.errorTooMuch+"</p>"),fixParentHeigth()}else $("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+metadata.msg+"</p>"),fixParentHeigth()}})};function isValueInArray(e,t){return e.reduce(function(e,a){return e||t.toLowerCase()==a.toLowerCase()},!1)}function passJSON(e,t,a,n){for(var i=[],o=0,l=parseInt($("#"+e+"_licount").val()),s=1;s<=l;){if($("#"+e+"_li_"+s).is(":visible")){var r={title:1==$("#"+e+"_show_title").val()?$("#"+e+"_title_"+s).val():"",comment:1==$("#"+e+"_show_comment").val()?$("#"+e+"_comment_"+s).val():"",size:$("#"+e+"_size_"+s).val(),name:$("#"+e+"_name_"+s).val(),filename:$("#"+e+"_filename_"+s).val(),ext:$("#"+e+"_ext_"+s).val()};o+=1,i.push(r)}s++}$("#"+e).val(JSON.stringify(i)),copyJSON(o,e,t,a,n)}var saveAndExit=function(e,t,a,n){var i=parseInt($("#"+e+"_filecount").val()),o=parseInt($("#"+e+"_minfiles").val());return 0!=o&&i<o&&showpopups?!!confirm(uploadLang.errorNeedMoreConfirm.replace("%s",o-i))&&(passJSON(e,t,a,n),!0):(passJSON(e,t,a,n),!0)},deletefile=function(e,t){var a,n=$("#"+e+"_filename_"+t).val(),i=$("#"+e+"_name_"+t).val(),o=parseInt($("#"+e+"_filecount").val()),l=parseInt($("#"+e+"_licount").val());$.ajax({method:"POST",url:uploadurl,data:{delete:1,fieldname:e,filename:n,name:i,YII_CSRF_TOKEN:csrfToken}}).done(function(n){for($("#notice").html('<p class="alert alert-success"><span class="fa fa-check"></span>&nbsp;'+n+"</p>"),setTimeout(function(){$(".success").remove()},5e3),$("#"+e+"_li_"+t).hide(),o--,$("#"+e+"_filecount").val(o),a=$("#"+e+"_file_index_"+t).val(),j=t;j<=l;j++)$("#"+e+"_li_"+j).is(":visible")&&($("#"+e+"_file_index_"+j).val(a),a++);var i=parseInt($("#"+e+"_minfiles").val()),s=parseInt($("#"+e+"_maxfiles").val());o<i?($("#uploadstatus").html(uploadLang.errorNeedMore.replace("%s",i-o)),fixParentHeigth()):($("#uploadstatus").html(uploadLang.errorMoreAllowed.replace("%s",s-o)),fixParentHeigth())})}};function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}